<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="google-site-verification" content="14dvQcWyDWHBo8aM0kld8XzEa6KypAzCQDz1_KPus9E" />
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1812620-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-1812620-2');
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
    styles: {
    ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
    },
    tex2jax: {
      inlineMath: [['$','$'], ['\\\\(','\\\\)']],
      displayMath: [['$$','$$'], ["\\[","\\]"]],
      processEscapes: true,
    }
    });
  </script>
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <!--<link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">-->
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments/github.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">
  <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bytepawn - Marton Trencseni Atom">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Marton Trencseni" />
<meta name="description" content="In real-life, non-digital situations, it's often not feasible to run true A/B tests. In such cases, we can compare before and after rollout conversions at a treatment site, while using a similar control site to measure and correct for seasonality. The post discusses how to compute increasingly correct p-values and bayesian probabilities in such scenarios." />
<meta name="keywords" content="ab-testing">
<meta property="og:site_name" content="Bytepawn - Marton Trencseni"/>
<meta property="og:title" content="Comparing conversion at control and treatment sites"/>
<meta property="og:description" content="In real-life, non-digital situations, it's often not feasible to run true A/B tests. In such cases, we can compare before and after rollout conversions at a treatment site, while using a similar control site to measure and correct for seasonality. The post discusses how to compute increasingly correct p-values and bayesian probabilities in such scenarios."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/comparing-conversion-at-control-and-treatment-sites.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-12-03 00:00:00+01:00"/>
<meta property="article:modified_time" content="2020-12-03 00:00:00+01:00"/>
<meta property="article:author" content="/author/marton-trencseni.html">
<meta property="article:section" content="Data"/>
<meta property="article:tag" content="ab-testing"/>
<meta property="og:image" content="/images/ct_site_control_bayes.png"/>

  <title>Bytepawn - Marton Trencseni &ndash; Comparing conversion at control and treatment sites</title>
</head>
<body>
  <aside>
    <div>
      <a href="/">
        <img src="/theme/img/profile.png" alt="" title="">
      </a>
      <!--<h2><a href="">Bytepawn - Marton Trencseni</a></h2>-->
      <h2><a href="http://bytepawn.com">Bytepawn</a></h2>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/">home</a></li>
          <li><a href="https://github.com/mtrencseni">github</a></li>
          <li><a href="https://www.linkedin.com/in/mtrencseni">linkedin</a></li>
          <li><a href="http://arxiv.org/find/all/1/au:+trencseni/0/1/0/all/0/1">arxiv</a></li>
        </ul>
      </nav>
      <ul class="social">
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="comparing-conversion-at-control-and-treatment-sites">Comparing conversion at control and treatment sites</h1>
    <p>Marton Trencseni - Thu 03 December 2020 - <a href="/category/data.html">Data</a></p>
  </header>
  <div>
    <h2>Introduction</h2>
<p>In real-life, non-digital situations, it's often not feasible to run true A/B tests. In such cases, we can compare before and after rollout conversions at a treatment site, while using a similar control site to measure and correct for seasonality. The post discusses how to compute increasingly correct p-values and bayesian probabilities in such scenarios.</p>
<p>Imagine a cinema selling movie tickets and upselling food and beverages, and experimenting with different pricing to see how it affects upsell conversion. For simplicity, let's say non-conversion means a customer buys just a movie ticket, whereas a conversion means a customer buys a movie ticket plus some food and beverages. Since the cinema is a real-life venue (not digital) the pricing is shown on large printed banners, and can't be varied per arriving customer (there may also be legal reasons).</p>
<p>In such situations, the experiment setup is:</p>
<p><img src="/images/ct_site_setup.png" alt="Control site and treatment site setup" style="width: 400px;"/></p>
<ol>
<li><strong>Treatment site:</strong> roll out the experimental pricing at the treatment site (let's day on Dec-1) and measure the change in conversion before vs. after rollout (let's say for a week).</li>
<li><strong>Control site:</strong> don't make any changes, and measure the change in conversion before vs. after rollout. The control lift can be used to estimate and subtract out the "seasonal" change from the treatment effect.</li>
</ol>
<p>It's important to note that even when using a control site, we're doing a best-effort estimation of conversion lift. We cannot be sure that any signal we pick up is due to the treatment we applied, and not some external factor. Some issues we face:</p>
<ol>
<li>The populations of the before and after (and even the control and treatment site) are not distinct: a customer could show up both at the control and the treatment site, both before and after the rollout. This could result in unexpected spill-over effects. If possible, it's best to exclude such customers from the study.</li>
<li>The treatment site and the control site will never be statistically exactly the same, so any seasonal correction we measure at the control site is only an approximation of the treatment site's. For example, if a new Bollywood movie comes out after the treatment is applied at the treatment site, and one of the sites draws more people from India, who are more likely to buy food and beverages along with the movie ticket, that will skew the results.</li>
<li>It's possible that an external event, unrelated to the pricing change, is causing a change at one of the sites after the rollout, and the lift we're measuring is due to this external reason and not the pricing change. For example, there is a big shop next to one of the sites, which closes down during the treatment period and skews the mix of people coming in to this site site.</li>
</ol>
<p>It would be tempting to say that "because of the above", only a strong signal (high lift, low p-value, high bayesian probability) should be accepted. But this is misleading, because external events like the above can cause a strong signal. The result of such a control vs treatment site analysis should only be accepted after careful checks of populations mixes along various splits, checking various metrics and other external factors (eg. nearby physical events) of the sites indicate that it's safe to proceed with the analysis.</p>
<p>Having laid out these caveats, the two main questions are:</p>
<ol>
<li>How can we compute an estimated treatment lift?</li>
<li>How can we compute an estimated significance (or bayesian probability of "after" being better than "before")?</li>
</ol>
<h2>Experiment setup</h2>
<p>Let's use the following toy numbers. Our measurements at the control site, before and after the rollout date:</p>
<p><img src="/images/ct_site_control_numbers.png" alt="Control site numbers" style="width: 400px;"/></p>
<p>At the treatment site, where we actually change the price:</p>
<p><img src="/images/ct_site_treatment_numbers_2.png" alt="Treatment site numbers" style="width: 400px;"/></p>
<h2>Estimating the treatment lift</h2>
<p>At the control site, before rollout, conversion was $ 997 / (996+997) = 50 \% $, after rollout $ 1089 / (1004+1089) = 52 \% $, so the control's relative lift in conversion is $ 0.52 / 0.50 - 1 = 4 \% $. Since we didn't make any change at the control site, we assume that this lift is a seasonal lift. Doing the same at the treatment site, the uncorrected, raw relative lift is $ 11.2 \% $. Subtracting out the seasonal lift leaves us with $ 11.2 \% - 4 \% = 7.2 \% $ "real", corrected lift.</p>
<p>Let's code it up:</p>
<div class="highlight"><pre><span></span><span class="n">control_site</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">996</span><span class="p">,</span> <span class="mi">1004</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">997</span><span class="p">,</span> <span class="mi">1089</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">treatment_site</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">888</span><span class="p">,</span>  <span class="mi">844</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">911</span><span class="p">,</span> <span class="mi">1088</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">conv_control_before</span> <span class="o">=</span> <span class="n">control_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">control_site</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">control_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">conv_control_after</span>  <span class="o">=</span> <span class="n">control_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">control_site</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">control_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="n">conv_control_lift</span> <span class="o">=</span> <span class="n">conv_control_after</span> <span class="o">/</span> <span class="n">conv_control_before</span> <span class="o">-</span> <span class="mf">1.0</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;conversion at control site before = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conv_control_before</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;conversion at control site after  = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conv_control_after</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;relative conversion lift at control = </span><span class="si">%.3f</span><span class="s1"> (assumed to be seasonality)&#39;</span> <span class="o">%</span> <span class="n">conv_control_lift</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>

<span class="n">conv_treatment_before</span> <span class="o">=</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">treatment_site</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">conv_treatment_after</span>  <span class="o">=</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">treatment_site</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="n">conv_treatment_lift</span> <span class="o">=</span> <span class="n">conv_treatment_after</span> <span class="o">/</span> <span class="n">conv_treatment_before</span> <span class="o">-</span> <span class="mf">1.0</span>
<span class="n">conv_treatment_lift_corr</span> <span class="o">=</span> <span class="n">conv_treatment_lift</span> <span class="o">-</span> <span class="n">conv_control_lift</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;conversion at treatment site before = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conv_treatment_before</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;conversion at treatment site after  = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conv_treatment_after</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;relative conversion lift at treatment = </span><span class="si">%.3f</span><span class="s1"> (including assumed seasonality)&#39;</span> <span class="o">%</span> <span class="n">conv_treatment_lift</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;relative conversion lift at treatment with correction (seasonality subtracted out) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conv_treatment_lift_corr</span><span class="p">)</span>
</pre></div>


<p>Prints:</p>
<div class="highlight"><pre><span></span>conversion at control site before = 0.50
conversion at control site after  = 0.52
relative conversion lift at control = 0.040 (assumed to be seasonality)

conversion at treatment site before = 0.51
conversion at treatment site after  = 0.56
relative conversion lift at treatment = 0.112 (including assumed seasonality)

relative conversion lift at treatment with correction (seasonality subtracted out) = 0.072
</pre></div>


<h2>Estimating the statistical significance of the treatment lift</h2>
<p>Based on the above analysis, it seems that the treatment worked, and taking into account seasonality, there is still a positive lift. But is it statistically significant? Naively, we could take the treatment site's contingency matrix, and compute a p-value from that:</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;p-value of original treatment site contingency matrix = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Prints:</p>
<div class="highlight"><pre><span></span>p-value of original treatment site contingency matrix = 0.001
</pre></div>


<p>But this is definitely not right, because we didn't take into account the fact that we normalized our conversion lift using the control site. A less wrong approach is to re-normalize the treatment site's contingency matrix, and calculate a p-value from that. First, re-normalize, fixing the "after" sample size, and re-distributing the non-conversion and conversion counts according to the corrected "after" conversion (which excludes the seasonality we compute using the control):</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">correct_treatment_contingency_matrix</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">conv_control_lift</span><span class="p">):</span>
    <span class="n">conv_treatment_before</span> <span class="o">=</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">treatment_site</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">conv_treatment_after</span>  <span class="o">=</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">treatment_site</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">treatment_site</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">conv_treatment_lift</span> <span class="o">=</span> <span class="n">conv_treatment_after</span> <span class="o">/</span> <span class="n">conv_treatment_before</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="n">conv_treatment_lift_corr</span> <span class="o">=</span> <span class="n">conv_treatment_lift</span> <span class="o">-</span> <span class="n">conv_control_lift</span>
    <span class="n">conv_treatment_after_corr</span> <span class="o">=</span> <span class="n">conv_treatment_before</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">conv_treatment_lift_corr</span><span class="p">)</span>
    <span class="n">treatment_site_corr</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">treatment_site_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">treatment_site_corr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">treatment_site_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conv_treatment_after_corr</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">treatment_site_corr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="n">treatment_site_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">treatment_site_corr</span>

<span class="n">treatment_site_corr</span> <span class="o">=</span> <span class="n">correct_treatment_contingency_matrix</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">conv_control_lift</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Original treatment site contingency matrix:&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Corrected treatment site contingency matrix:&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">treatment_site_corr</span><span class="p">))</span>
</pre></div>


<p>Prints:</p>
<div class="highlight"><pre><span></span>Original treatment site contingency matrix:
[[ 888  844]
 [ 911 1088]]
Corrected treatment site contingency matrix:
[[ 888  883]
 [ 911 1049]]
</pre></div>


<p>And now we can calculate a more meaningful p-value:</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;p-value of corrected treatment site contingency matrix = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">treatment_site_corr</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Prints:</p>
<div class="highlight"><pre><span></span>p-value of corrected treatment site contingency matrix = 0.029
</pre></div>


<p>Because the seasonality was positive, it corrected the positive lift to be lower, which naturally results in a higher p-value, less statistical significance.</p>
<h2>Estimating the Bayesian probability that the treatment lift is higher</h2>
<p>Similar to the above, we can also use the corrected contingency matrix to calculate the Bayesian probability that the conversion at the treatment site is higher after the treatment was applied vs before. I've <a href="http://bytepawn.com/bayesian-ab-conversion-tests.html">described in detail how to calculate Bayesian conversion probabilities in this previous post</a>. We can either use a closed form solution or use Monte Carlo sampling to compute the probability. Since we will use Monte Carlo simulations later anyway, let's go that route:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample_conversion_lifts</span><span class="p">(</span><span class="n">site_contingency</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">beta_before</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">site_contingency</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">site_contingency</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">beta_after</span>  <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">site_contingency</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">site_contingency</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">samples_before</span> <span class="o">=</span> <span class="n">beta_before</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
    <span class="n">samples_after</span>  <span class="o">=</span> <span class="n">beta_after</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples_before</span><span class="p">,</span> <span class="n">samples_after</span>

<span class="k">def</span> <span class="nf">bayesian_prob_after_gt_before</span><span class="p">(</span><span class="n">site_contingency</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">samples_before</span><span class="p">,</span> <span class="n">samples_after</span> <span class="o">=</span> <span class="n">sample_conversion_lifts</span><span class="p">(</span><span class="n">site_contingency</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">after</span> <span class="o">&gt;</span> <span class="n">before</span> <span class="k">for</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples_before</span><span class="p">,</span> <span class="n">samples_after</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">hits</span><span class="o">/</span><span class="n">num_samples</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;P(conv_after &gt; conv_before | treatment_site     ): </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bayesian_prob_after_gt_before</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;P(conv_after &gt; conv_before | treatment_site_corr): </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bayesian_prob_after_gt_before</span><span class="p">(</span><span class="n">treatment_site_corr</span><span class="p">))</span>
</pre></div>


<p>Prints:</p>
<div class="highlight"><pre><span></span>P(conv_after &gt; conv_before | treatment_site     ) = 0.9997
P(conv_after &gt; conv_before | treatment_site_corr) = 0.9859
</pre></div>


<p>The story is the same as above: since the corrected conversion lift is lower, the probability of the effect being real is a bit lower ($ 98.6 \% $ vs $ 99.9 \% $).</p>
<h2>Using Bayesian Monte Carlo methods to take into account the sample size at the control site</h2>
<p>From a mathematical perspective, the big shortcoming of the above analysis (both the frequentist p-value and the bayesian) is that it ignores the sample size at the control site. In other words, when we compute <code>conv_control_lift</code> and then <code>conv_treatment_lift_corr</code>:</p>
<div class="highlight"><pre><span></span><span class="n">conv_control_lift</span> <span class="o">=</span> <span class="n">conv_control_after</span> <span class="o">/</span> <span class="n">conv_control_before</span> <span class="o">-</span> <span class="mf">1.0</span>
<span class="o">...</span>
<span class="n">conv_treatment_lift_corr</span> <span class="o">=</span> <span class="n">conv_treatment_lift</span> <span class="o">-</span> <span class="n">conv_control_lift</span>
</pre></div>


<p>We take the <code>conv_control_lift</code> point estimate at face value, without taking into account that this lift at the control site is also a random variable, with spread around a mean. It could also be just random fluctuation.</p>
<p>To model the uncertainty at the control site, we can use the <a href="https://en.wikipedia.org/wiki/Beta_distribution">Beta distribution</a> we know from <a href="http://bytepawn.com/bayesian-ab-conversion-tests.html">Bayesian A/B testing</a> and perform a Monte Carlo simulation.</p>
<ol>
<li>Model the "before" conversion at the control site with a Beta distribution.</li>
<li>Model the "after" conversion at the control site with a Beta distribution.</li>
<li>In a Monte Carlo simulation, <code>num_sample</code> times:</li>
<li>Draw pairs of "before" and "after" conversion probabilities from the above distributions, and using these sampled conversions compute a sampled control conversion lift.</li>
</ol>
<p>First, let's illustrate these steps in code:</p>
<div class="highlight"><pre><span></span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">1000</span>
<span class="n">samples_conv_control_before</span><span class="p">,</span> <span class="n">samples_conv_control_after</span> <span class="o">=</span> <span class="n">sample_conversion_lifts</span><span class="p">(</span><span class="n">control_site</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="n">samples_conv_control_lift</span> <span class="o">=</span> <span class="p">[</span><span class="n">after</span><span class="o">/</span><span class="n">before</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples_conv_control_before</span><span class="p">,</span> <span class="n">samples_conv_control_after</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samples_conv_control_lift</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;mean relative conversion lift at control = </span><span class="si">%.3f</span><span class="s1"> (assumed to be seasonality)&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples_conv_control_lift</span><span class="p">))</span>
</pre></div>


<p>Prints:</p>
<p><img src="/images/ct_site_control_bayes.png" alt="Monte Carlo simulated control lifts" style="width: 500px;"/></p>
<div class="highlight"><pre><span></span>mean relative conversion lift at control = 0.041 (assumed to be seasonality)
</pre></div>


<p>We can then feed these sampled lifts at the control site into our subsequent calculations. Continuing the above:</p>
<ol>
<li>Using the sampled conversion lift, repeat the frequentist or bayesian analysis above to get a p-value or a bayesian probability</li>
</ol>
<p>Code for the frequentist p-value case:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">p_value_corr</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">conv_control_lift</span><span class="p">):</span>
    <span class="n">treatment_site_corr</span> <span class="o">=</span> <span class="n">correct_treatment_contingency_matrix</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">conv_control_lift</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">treatment_site_corr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">1000</span>
<span class="n">samples_conv_control_before</span><span class="p">,</span> <span class="n">samples_conv_control_after</span> <span class="o">=</span> <span class="n">sample_conversion_lifts</span><span class="p">(</span><span class="n">control_site</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="n">samples_conv_control_lift</span> <span class="o">=</span> <span class="p">[</span><span class="n">after</span><span class="o">/</span><span class="n">before</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples_conv_control_before</span><span class="p">,</span> <span class="n">samples_conv_control_after</span><span class="p">)]</span>
<span class="n">ps</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_value_corr</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">lift</span><span class="p">)</span> <span class="k">for</span> <span class="n">lift</span> <span class="ow">in</span> <span class="n">samples_conv_control_lift</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;p-value of corrected treatment site contingency matrix (taking into account control site uncertainty) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ps</span><span class="p">))</span>
</pre></div>


<p>Prints:</p>
<p><img src="/images/ct_site_mc_p.png" alt="Monte Carlo simulated p-values" style="width: 500px;"/></p>
<div class="highlight"><pre><span></span>p-value of corrected treatment site contingency matrix (taking into account control site uncertainty) = 0.115
</pre></div>


<p>Note that this is a significant adjustment: without taking into account the control site's uncertainty, the p-value was 0.029, about 4x less in this example!</p>
<p>We can repeat the same to get an adjusted Bayesian probability:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bayesian_prob_corr</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">conv_control_lift</span><span class="p">):</span>
    <span class="n">treatment_site_corr</span> <span class="o">=</span> <span class="n">correct_treatment_contingency_matrix</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">conv_control_lift</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bayesian_prob_after_gt_before</span><span class="p">(</span><span class="n">treatment_site_corr</span><span class="p">)</span>

<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span>
<span class="n">samples_conv_control_before</span><span class="p">,</span> <span class="n">samples_conv_control_after</span> <span class="o">=</span> <span class="n">sample_conversion_lifts</span><span class="p">(</span><span class="n">control_site</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="n">samples_conv_control_lift</span> <span class="o">=</span> <span class="p">[</span><span class="n">after</span><span class="o">/</span><span class="n">before</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples_conv_control_before</span><span class="p">,</span> <span class="n">samples_conv_control_after</span><span class="p">)]</span>
<span class="n">bs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bayesian_prob_corr</span><span class="p">(</span><span class="n">treatment_site</span><span class="p">,</span> <span class="n">lift</span><span class="p">)</span> <span class="k">for</span> <span class="n">lift</span> <span class="ow">in</span> <span class="n">samples_conv_control_lift</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;P(conv_after &gt; conv_before | treatment_site_corr) (taking into account control site uncertainty) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs</span><span class="p">))</span>
</pre></div>


<p>Prints:</p>
<p><img src="/images/ct_site_mc_bayes.png" alt="Monte Carlo simulated bayesian probabilities" style="width: 500px;"/></p>
<div class="highlight"><pre><span></span>P(conv_after &gt; conv_before | treatment_site_corr) (taking into account control site uncertainty) = 0.942
</pre></div>


<p>Similar to the frequentist case, this is a significant adjustment: without taking into account the control site's uncertainty, the probability was $ 98.5 \% $, while this calculation yields a more realistic $ 94.2 \% $. Like in the frequentist case, $ 1-P $ increases by 4x.</p>
<h2>Conclusion</h2>
<p>The main takeaways here are:</p>
<ol>
<li>Conducting such a control vs target site experiment is dangerous, as the lack of randomized populations and the presence of externals effects can easily mislead us --- if possible it's best to avoid this.</li>
<li>We should conduct extensive checks to minimize the risk of external effects polluting the measurement.</li>
<li>We have to take into account the uncertainty of the control site.</li>
</ol>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/ab-testing.html">ab-testing</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Marton Trencseni </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1812620-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1812620-2');
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Comparing conversion at control and treatment sites",
  "headline": "Comparing conversion at control and treatment sites",
  "datePublished": "2020-12-03 00:00:00+01:00",
  "dateModified": "2020-12-03 00:00:00+01:00",
  "author": {
    "@type": "Person",
    "name": "Marton Trencseni",
    "url": "/author/marton-trencseni.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "/comparing-conversion-at-control-and-treatment-sites.html",
  "description": "In real-life, non-digital situations, it's often not feasible to run true A/B tests. In such cases, we can compare before and after rollout conversions at a treatment site, while using a similar control site to measure and correct for seasonality. The post discusses how to compute increasingly correct p-values and bayesian probabilities in such scenarios."
}
</script></body>
</html>